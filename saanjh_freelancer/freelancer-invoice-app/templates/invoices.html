{% extends 'base.html' %}
{% block content %}
<div class="container">
  <h2 class="text-center mb-4">ðŸ§¾ Invoices</h2>

  <div class="text-end mb-3">
    <a href="{{ url_for('add_invoice') }}" class="btn btn-primary">
      <i class="fa-solid fa-plus"></i> Add Invoice
    </a>
  </div>

  {% if data %}
  <div class="table-responsive">
    <table class="table table-bordered table-striped align-middle shadow-sm">
      <thead class="table-dark">
        <tr>
          <th>ID</th>
          <th>Client</th>
          <th>Date</th>
          <th>Due Date</th>
          <th>Status</th>
          <th>Total (Rs)</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for row in data %}
        {% set inv = row.invoice %}
        {% set inv_due = inv['due_date'] %}

        <tr>
          <td>{{ inv['id'] }}</td>
          <td>{{ inv['client'] }}</td>
          <td>{{ inv['date'] }}</td>
          <td>{{ inv_due }}</td>

          <td>
            {% if inv['paid'] == 1 %}
              <span class="badge bg-success">Paid</span>
            {% elif inv_due < today|string %}
              <span class="badge bg-danger">Overdue</span>
            {% else %}
              <span class="badge bg-warning text-dark">Unpaid</span>
            {% endif %}
          </td>

          <td>{{ "%.2f"|format(row.total) }}</td>

          <td>
            <!-- âœ… Mark Paid/Unpaid Toggle -->
            {% if inv['paid'] == 0 %}
              <a href="{{ url_for('mark_paid', id=inv['id']) }}" class="btn btn-success btn-sm">
                <i class="fa-solid fa-check"></i> Mark Paid
              </a>
            {% else %}
              <a href="{{ url_for('mark_paid', id=inv['id']) }}" class="btn btn-outline-success btn-sm">
                <i class="fa-solid fa-rotate-left"></i> Mark Unpaid
              </a>
            {% endif %}

            <!-- âœï¸ Edit -->
            <a href="{{ url_for('edit_invoice', id=inv['id']) }}" class="btn btn-warning btn-sm me-1">
              <i class="fa-solid fa-pen"></i>
            </a>

            <!-- âŒ Delete -->
            <a href="{{ url_for('delete_invoice', id=inv['id']) }}"
               class="btn btn-danger btn-sm me-1"
               onclick="return confirm('Delete this invoice?');">
              <i class="fa-solid fa-trash"></i>
            </a>

            <a href="{{ url_for('invoice_pdf', id=inv['id']) }}" 
   class="btn btn-sm btn-secondary" 
   title="Download PDF Invoice">
   <i class="fas fa-file-pdf me-1"></i> PDF
</a>

</a>

</a>

            </a>
          </td>
        </tr>

        <!-- Invoice Items -->
        <tr class="bg-light">
          <td colspan="7">
            <strong>Invoice Items:</strong>
            <table class="table table-sm table-bordered mt-2 mb-0">
              <thead class="table-secondary">
                <tr>
                  <th>Description</th>
                  <th>Rate (Rs)</th>
                  <th>Quantity</th>
                  <th>Subtotal (Rs)</th>
                </tr>
              </thead>
              <tbody>
                {% for item in row['items'] %}
                <tr>
                  <td>{{ item['description'] }}</td>
                  <td>{{ item['rate'] }}</td>
                  <td>{{ item['quantity'] }}</td>
                  <td>{{ "%.2f"|format(item['subtotal']) }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </td>
        </tr>

        {% endfor %}
      </tbody>
    </table>
  </div>

  {% else %}
  <div class="alert alert-info text-center mt-4">
    No invoices found yet.
  </div>
  {% endif %}
</div>
{% endblock %}
